"""rename_model_vars_with_units

Revision ID: 1e2ca98f0dfe
Revises: 3d67080ef6f5
Create Date: 2026-02-03 17:18:13.716376

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.engine.reflection import Inspector


# revision identifiers, used by Alembic.
revision: str = '1e2ca98f0dfe'
down_revision: Union[str, None] = '3d67080ef6f5'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    bind = op.get_bind()
    inspector = sa.inspect(bind)
    all_tables = inspector.get_table_names()

    # CRITICAL: Clean up leftover temp tables from failed migrations
    for table in all_tables:
        if table.startswith('_alembic_tmp_'):
            op.drop_table(table)

    # 0. DROP DEPENDENT VIEWS (Fix for sqlite3.OperationalError)
    op.execute("DROP VIEW IF EXISTS v_experiment_additives_summary")

    # ### commands auto generated by Alembic - please adjust! ###
    
    # 1. Chemical Additives - Enum change (use batch mode)
    with op.batch_alter_table('chemical_additives', schema=None) as batch_op:
        batch_op.alter_column('unit',
               existing_type=sa.VARCHAR(length=10),
               type_=sa.Enum('GRAM', 'MILLIGRAM', 'MICROGRAM', 'KILOGRAM', 'MICROLITER', 'MILLILITER', 'LITER', 'MICROMOLE', 'MILLIMOLE', 'MOLE', 'PPM', 'MILLIMOLAR', 'MOLAR', 'PERCENT_OF_ROCK', name='amountunit'),
               existing_nullable=False)

    # 2. Compounds - Renames (Use alter_column with new_column_name)
    with op.batch_alter_table('compounds', schema=None) as batch_op:
        # Rename columns
        batch_op.alter_column('molecular_weight', new_column_name='molecular_weight_g_mol')
        batch_op.alter_column('density', new_column_name='density_g_cm3')
        batch_op.alter_column('melting_point', new_column_name='melting_point_c')
        batch_op.alter_column('boiling_point', new_column_name='boiling_point_c')
        
        # Alter preferred_unit enum
        batch_op.alter_column('preferred_unit',
               existing_type=sa.VARCHAR(length=10),
               type_=sa.Enum('GRAM', 'MILLIGRAM', 'MICROGRAM', 'KILOGRAM', 'MICROLITER', 'MILLILITER', 'LITER', 'MICROMOLE', 'MILLIMOLE', 'MOLE', 'PPM', 'MILLIMOLAR', 'MOLAR', 'PERCENT_OF_ROCK', name='amountunit'),
               existing_nullable=True)

    # 3. Elemental Analysis - Nullability change (SKIPPING to avoid IntegrityError on existing NULLs)
    # with op.batch_alter_table('elemental_analysis', schema=None) as batch_op:
    #    batch_op.alter_column('external_analysis_id',
    #           existing_type=sa.INTEGER(),
    #           nullable=False)

    # 4. Experimental Conditions - Renames
    with op.batch_alter_table('experimental_conditions', schema=None) as batch_op:
        # Renames
        batch_op.alter_column('rock_mass', new_column_name='rock_mass_g')
        batch_op.alter_column('water_volume', new_column_name='water_volume_mL')
        batch_op.alter_column('temperature', new_column_name='temperature_c')
        batch_op.alter_column('room_temp_pressure', new_column_name='room_temp_pressure_psi')
        batch_op.alter_column('rxn_temp_pressure', new_column_name='rxn_temp_pressure_psi')
        batch_op.alter_column('stir_speed', new_column_name='stir_speed_rpm')
        batch_op.alter_column('core_height', new_column_name='core_height_cm')
        batch_op.alter_column('core_width', new_column_name='core_width_cm')
        batch_op.alter_column('core_volume', new_column_name='core_volume_cm3')
        batch_op.alter_column('co2_partial_pressure', new_column_name='co2_partial_pressure_MPa')

    # 5. Experiments - Enum change
    with op.batch_alter_table('experiments', schema=None) as batch_op:
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=11),
               type_=sa.Enum('ONGOING', 'COMPLETED', 'CANCELLED', name='experimentstatus'),
               existing_nullable=True)
        # Skip self-referential FK creation for parent_experiment_fk to avoid circular dependency in SQLite

    # 6. External Analyses - Drop FK (SKIPPING: FK constraints in SQLite often lack names)
    # This change is not related to renaming columns with units and causes ValueError
    # with op.batch_alter_table('external_analyses', schema=None) as batch_op:
    #     fks = inspector.get_foreign_keys('external_analyses')
    #     for fk in fks:
    #         if 'pxrf_readings' in fk['referred_table'] and fk['name']:
    #             batch_op.drop_constraint(fk['name'], type_='foreignkey')

    # 7. Scalar Results - Renames and FK
    with op.batch_alter_table('scalar_results', schema=None) as batch_op:
        # Renames
        batch_op.alter_column('gross_ammonium_concentration', new_column_name='gross_ammonium_concentration_mM')
        batch_op.alter_column('background_ammonium_concentration', new_column_name='background_ammonium_concentration_mM')
        batch_op.alter_column('final_nitrate_concentration', new_column_name='final_nitrate_concentration_mM')
        batch_op.alter_column('final_dissolved_oxygen', new_column_name='final_dissolved_oxygen_mg_L')
        batch_op.alter_column('final_conductivity', new_column_name='final_conductivity_mS_cm')
        batch_op.alter_column('final_alkalinity', new_column_name='final_alkalinity_mg_L')
        batch_op.alter_column('sampling_volume', new_column_name='sampling_volume_mL')
        batch_op.alter_column('gas_sampling_pressure', new_column_name='gas_sampling_pressure_MPa')
        batch_op.alter_column('co2_partial_pressure', new_column_name='co2_partial_pressure_MPa')
        batch_op.alter_column('h2_moles', new_column_name='h2_micromoles')
        # h2_mass_g -> h2_mass_ug rename
        batch_op.alter_column('h2_mass_g', new_column_name='h2_mass_ug')
        
        # Add new FK (named)
        batch_op.create_foreign_key('fk_scalar_results_background_experiment_fk', 'experiments', ['background_experiment_fk'], ['id'], ondelete='SET NULL')

    # 8. Recreate View
    op.execute("""
        CREATE VIEW IF NOT EXISTS v_experiment_additives_summary AS
        SELECT e.experiment_id AS experiment_id,
               GROUP_CONCAT(c.name || ' ' || CAST(a.amount AS TEXT) || ' ' || a.unit, '; ') AS additives_summary
        FROM chemical_additives a
        JOIN experimental_conditions ec ON ec.id = a.experiment_id
        JOIN experiments e ON e.id = ec.experiment_fk
        JOIN compounds c ON c.id = a.compound_id
        GROUP BY e.experiment_id;
    """)

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    bind = op.get_bind()
    inspector = sa.inspect(bind)
    
    # 0. DROP VIEW
    op.execute("DROP VIEW IF EXISTS v_experiment_additives_summary")

    # 1. Scalar Results - Undo Renames and Drop FK
    with op.batch_alter_table('scalar_results', schema=None) as batch_op:
        batch_op.drop_constraint('fk_scalar_results_background_experiment_fk', type_='foreignkey')
        
        batch_op.alter_column('gross_ammonium_concentration_mM', new_column_name='gross_ammonium_concentration')
        batch_op.alter_column('background_ammonium_concentration_mM', new_column_name='background_ammonium_concentration')
        batch_op.alter_column('final_nitrate_concentration_mM', new_column_name='final_nitrate_concentration')
        batch_op.alter_column('final_dissolved_oxygen_mg_L', new_column_name='final_dissolved_oxygen')
        batch_op.alter_column('final_conductivity_mS_cm', new_column_name='final_conductivity')
        batch_op.alter_column('final_alkalinity_mg_L', new_column_name='final_alkalinity')
        batch_op.alter_column('sampling_volume_mL', new_column_name='sampling_volume')
        batch_op.alter_column('gas_sampling_pressure_MPa', new_column_name='gas_sampling_pressure')
        batch_op.alter_column('co2_partial_pressure_MPa', new_column_name='co2_partial_pressure')
        batch_op.alter_column('h2_micromoles', new_column_name='h2_moles')
        batch_op.alter_column('h2_mass_ug', new_column_name='h2_mass_g')

    # 2. External Analyses - Restore FK (SKIPPING: Corresponding upgrade step was skipped)
    # with op.batch_alter_table('external_analyses', schema=None) as batch_op:
    #     batch_op.create_foreign_key('fk_external_analyses_pxrf_reading_no', 'pxrf_readings', ['pxrf_reading_no'], ['reading_no'], ondelete='SET NULL')

    # 3. Experiments - Undo Enum change
    with op.batch_alter_table('experiments', schema=None) as batch_op:
        batch_op.alter_column('status',
               existing_type=sa.Enum('ONGOING', 'COMPLETED', 'CANCELLED', name='experimentstatus'),
               type_=sa.VARCHAR(length=11),
               existing_nullable=True)
        # Self-referential FK was skipped in upgrade, so nothing to drop here

    # 4. Experimental Conditions - Undo Renames
    with op.batch_alter_table('experimental_conditions', schema=None) as batch_op:
        batch_op.alter_column('rock_mass_g', new_column_name='rock_mass')
        batch_op.alter_column('water_volume_mL', new_column_name='water_volume')
        batch_op.alter_column('temperature_c', new_column_name='temperature')
        batch_op.alter_column('room_temp_pressure_psi', new_column_name='room_temp_pressure')
        batch_op.alter_column('rxn_temp_pressure_psi', new_column_name='rxn_temp_pressure')
        batch_op.alter_column('stir_speed_rpm', new_column_name='stir_speed')
        batch_op.alter_column('core_height_cm', new_column_name='core_height')
        batch_op.alter_column('core_width_cm', new_column_name='core_width')
        batch_op.alter_column('core_volume_cm3', new_column_name='core_volume')
        batch_op.alter_column('co2_partial_pressure_MPa', new_column_name='co2_partial_pressure')

    # 5. Elemental Analysis - Undo Nullability
    # with op.batch_alter_table('elemental_analysis', schema=None) as batch_op:
    #    batch_op.alter_column('external_analysis_id',
    #           existing_type=sa.INTEGER(),
    #           nullable=True)

    # 6. Compounds - Undo Renames
    with op.batch_alter_table('compounds', schema=None) as batch_op:
        batch_op.alter_column('molecular_weight_g_mol', new_column_name='molecular_weight')
        batch_op.alter_column('density_g_cm3', new_column_name='density')
        batch_op.alter_column('melting_point_c', new_column_name='melting_point')
        batch_op.alter_column('boiling_point_c', new_column_name='boiling_point')
        
        batch_op.alter_column('preferred_unit',
               existing_type=sa.Enum('GRAM', 'MILLIGRAM', 'MICROGRAM', 'KILOGRAM', 'MICROLITER', 'MILLILITER', 'LITER', 'MICROMOLE', 'MILLIMOLE', 'MOLE', 'PPM', 'MILLIMOLAR', 'MOLAR', 'PERCENT_OF_ROCK', name='amountunit'),
               type_=sa.VARCHAR(length=10),
               existing_nullable=True)

    # 7. Chemical Additives - Undo Enum
    with op.batch_alter_table('chemical_additives', schema=None) as batch_op:
        batch_op.alter_column('unit',
               existing_type=sa.Enum('GRAM', 'MILLIGRAM', 'MICROGRAM', 'KILOGRAM', 'MICROLITER', 'MILLILITER', 'LITER', 'MICROMOLE', 'MILLIMOLE', 'MOLE', 'PPM', 'MILLIMOLAR', 'MOLAR', 'PERCENT_OF_ROCK', name='amountunit'),
               type_=sa.VARCHAR(length=10),
               existing_nullable=False)

    # 8. Recreate View (Original definition)
    op.execute("""
        CREATE VIEW IF NOT EXISTS v_experiment_additives_summary AS
        SELECT e.experiment_id AS experiment_id,
               GROUP_CONCAT(c.name || ' ' || CAST(a.amount AS TEXT) || ' ' || a.unit, '; ') AS additives_summary
        FROM chemical_additives a
        JOIN experimental_conditions ec ON ec.id = a.experiment_id
        JOIN experiments e ON e.id = ec.experiment_fk
        JOIN compounds c ON c.id = a.compound_id
        GROUP BY e.experiment_id;
    """)
